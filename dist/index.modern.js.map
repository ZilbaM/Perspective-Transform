{"version":3,"file":"index.modern.js","sources":["../src/index.js"],"sourcesContent":["import React, { useState, useRef, useLayoutEffect, useEffect } from \"react\";\nimport styled from \"styled-components\";\n\nconst PerspectiveContainer = styled.div`\n  width: fit-content;\n  position: relative;\n`;\n\nconst ControlPoint = styled.div`\n  position: absolute;\n  width: 10px;\n  height: 10px;\n  background-color: red;\n  border-radius: 50%;\n  cursor: pointer;\n  transform: translate(-50%, -50%);\n`;\n\nfunction PerspectiveTransform({ children }) {\n  const containerRef = useRef(null);\n  const [points, setPoints] = useState({\n    topLeft: { x: 0, y: 0 },\n    topRight: { x: 100, y: 0 },\n    bottomRight: { x: 100, y: 100 },\n    bottomLeft: { x: 0, y: 100 },\n  });\n  const [matrix, setMatrix] = useState(\"\");\n  const [editable, setEditable] = useState(false); // Editable state\n\n  // Function to compute the CSS matrix\n  function computeCssMatrix(srcPoints, dstPoints) {\n    function solve(A, b) {\n      // Solve A * x = b\n      const det =\n        A[0] * (A[4] * A[8] - A[5] * A[7]) -\n        A[1] * (A[3] * A[8] - A[5] * A[6]) +\n        A[2] * (A[3] * A[7] - A[4] * A[6]);\n\n      if (det === 0) return null;\n\n      const invDet = 1 / det;\n\n      const adjA = [\n        A[4] * A[8] - A[5] * A[7],\n        A[2] * A[7] - A[1] * A[8],\n        A[1] * A[5] - A[2] * A[4],\n        A[5] * A[6] - A[3] * A[8],\n        A[0] * A[8] - A[2] * A[6],\n        A[2] * A[3] - A[0] * A[5],\n        A[3] * A[7] - A[4] * A[6],\n        A[1] * A[6] - A[0] * A[7],\n        A[0] * A[4] - A[1] * A[3],\n      ].map((val) => val * invDet);\n\n      return [\n        adjA[0] * b[0] + adjA[1] * b[1] + adjA[2] * b[2],\n        adjA[3] * b[0] + adjA[4] * b[1] + adjA[5] * b[2],\n        adjA[6] * b[0] + adjA[7] * b[1] + adjA[8] * b[2],\n      ];\n    }\n\n    function adj(m) {\n      return [\n        m[4] * m[8] - m[5] * m[7],\n        m[2] * m[7] - m[1] * m[8],\n        m[1] * m[5] - m[2] * m[4],\n        m[5] * m[6] - m[3] * m[8],\n        m[0] * m[8] - m[2] * m[6],\n        m[2] * m[3] - m[0] * m[5],\n        m[3] * m[7] - m[4] * m[6],\n        m[1] * m[6] - m[0] * m[7],\n        m[0] * m[4] - m[1] * m[3],\n      ];\n    }\n\n    function multmm(a, b) {\n      const c = [];\n      for (let i = 0; i < 3; i += 1) {\n        for (let j = 0; j < 3; j += 1) {\n          let cij = 0;\n          for (let k = 0; k < 3; k += 1) {\n            cij += a[3 * i + k] * b[3 * k + j];\n          }\n          c[3 * i + j] = cij;\n        }\n      }\n      return c;\n    }\n\n    function basisToPoints(p1, p2, p3, p4) {\n      const m = [p1.x, p2.x, p3.x, p1.y, p2.y, p3.y, 1, 1, 1];\n      const v = [p4.x, p4.y, 1];\n      const s = solve(m, v);\n      if (s === null) return null;\n      const m2 = [\n        m[0] * s[0],\n        m[1] * s[1],\n        m[2] * s[2],\n        m[3] * s[0],\n        m[4] * s[1],\n        m[5] * s[2],\n        m[6] * s[0],\n        m[7] * s[1],\n        m[8] * s[2],\n      ];\n      return m2;\n    }\n\n    const m1 = basisToPoints(\n      srcPoints[0],\n      srcPoints[1],\n      srcPoints[2],\n      srcPoints[3]\n    );\n    const m2 = basisToPoints(\n      dstPoints[0],\n      dstPoints[1],\n      dstPoints[2],\n      dstPoints[3]\n    );\n    if (m1 === null || m2 === null) return \"\";\n\n    const m3 = multmm(m2, adj(m1));\n\n    // Normalize the matrix\n    for (let i = 0; i < m3.length; i += 1) {\n      m3[i] /= m3[8];\n    }\n\n    const matrix3d = [\n      m3[0],\n      m3[3],\n      0,\n      m3[6],\n      m3[1],\n      m3[4],\n      0,\n      m3[7],\n      0,\n      0,\n      1,\n      0,\n      m3[2],\n      m3[5],\n      0,\n      m3[8],\n    ];\n\n    return `matrix3d(${matrix3d.join(\",\")})`;\n  }\n\n  // Use useLayoutEffect to ensure the DOM is ready\n  useLayoutEffect(() => {\n    if (containerRef.current) {\n      const rect = containerRef.current.getBoundingClientRect();\n      // Ensure width and height are not zero\n      if (rect.width > 0 && rect.height > 0) {\n        setPoints({\n          topLeft: { x: 0, y: 0 },\n          topRight: { x: rect.width, y: 0 },\n          bottomRight: { x: rect.width, y: rect.height },\n          bottomLeft: { x: 0, y: rect.height },\n        });\n      }\n    }\n  }, [children]); // Re-run when children change\n\n  useLayoutEffect(() => {\n    if (containerRef.current) {\n      const rect = containerRef.current.getBoundingClientRect();\n      if (rect.width === 0 || rect.height === 0) return; // Skip if dimensions are zero\n\n      const srcCorners = [\n        { x: 0, y: 0 },\n        { x: rect.width, y: 0 },\n        { x: rect.width, y: rect.height },\n        { x: 0, y: rect.height },\n      ];\n      const dstCorners = [\n        points.topLeft,\n        points.topRight,\n        points.bottomRight,\n        points.bottomLeft,\n      ];\n      const transform = computeCssMatrix(srcCorners, dstCorners);\n      setMatrix(transform);\n    }\n  }, [points]);\n\n  const handleDrag = (e, corner) => {\n    e.preventDefault();\n    e.stopPropagation();\n\n    const onMove = (event) => {\n      if (containerRef.current) {\n        const rect = containerRef.current.getBoundingClientRect();\n        const x = event.clientX - rect.left;\n        const y = event.clientY - rect.top;\n\n        setPoints((prevPoints) => ({\n          ...prevPoints,\n          [corner]: { x, y },\n        }));\n      }\n    };\n\n    const onUp = () => {\n      document.removeEventListener(\"mousemove\", onMove);\n      document.removeEventListener(\"mouseup\", onUp);\n    };\n\n    document.addEventListener(\"mousemove\", onMove);\n    document.addEventListener(\"mouseup\", onUp);\n  };\n\n  // Toggle editable state with Shift+P\n  useEffect(() => {\n    const handleKeyDown = (e) => {\n      if (e.shiftKey && (e.key === \"p\" || e.key === \"P\")) {\n        setEditable((prevEditable) => !prevEditable);\n      }\n    };\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => {\n      window.removeEventListener(\"keydown\", handleKeyDown);\n    };\n  }, []);\n\n  return (\n    <PerspectiveContainer ref={containerRef}>\n      <div\n        style={{\n          transform: matrix,\n          transformOrigin: \"0 0\",\n          width: \"100%\",\n          height: \"100%\",\n        }}\n      >\n        {children}\n      </div>\n\n      {editable &&\n        Object.entries(points).map(([corner, { x, y }]) => (\n          <ControlPoint\n            key={corner}\n            style={{ left: x, top: y }}\n            onMouseDown={(e) => handleDrag(e, corner)}\n          />\n        ))}\n    </PerspectiveContainer>\n  );\n}\n\nexport default PerspectiveTransform;\n"],"names":["_t","_t2","_","t","PerspectiveContainer","styled","div","ControlPoint","PerspectiveTransform","children","containerRef","useRef","points","setPoints","useState","topLeft","x","y","topRight","bottomRight","bottomLeft","matrix","setMatrix","editable","setEditable","useLayoutEffect","current","rect","getBoundingClientRect","width","height","transform","srcPoints","dstPoints","basisToPoints","p1","p2","p3","p4","m","s","A","b","det","invDet","adjA","map","val","solve","m1","m2","m3","a","c","i","j","cij","k","multmm","length","join","computeCssMatrix","useEffect","handleKeyDown","e","shiftKey","key","prevEditable","window","addEventListener","removeEventListener","React","createElement","ref","style","transformOrigin","Object","entries","corner","left","top","onMouseDown","handleDrag","preventDefault","stopPropagation","onMove","event","clientX","clientY","prevPoints","_extends","onUp","document"],"mappings":"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"}